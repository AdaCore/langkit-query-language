variables:
   # The common part of the URL for cloning from within a CI
   GIT_CLONE_BASE: https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}:${CI_SERVER_PORT}

stages:
  - test

test:
  services:
     - image:e3
     - cpu:8
  stage: test
  interruptible: true
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    # - if: $CI_COMMIT_BRANCH == 'master' && $CI_COMMIT_TITLE =~ /Merge branch.*/
  script:

    # Temporary: clone the specific branch of ci-fragments
    - ( cd /tmp && git clone $GIT_CLONE_BASE/eng/it/ci-fragments --branch topic/generic_ci_phase_2-next --depth 1 )
    - export PATH=/tmp/ci-fragments:$PATH

    - generic_anod_ci
    - cat /tmp/ci_env.sh
    - . /tmp/ci_env.sh

    - anod run --plan .gitlab-ci.plan $LKQL_VARIANT
    - testsuite_reports

  parallel:
    matrix:
      - LKQL_VARIANT: [lkql, lkql_jit, lkql_native_jit]
  artifacts:
    reports:
      junit: xunit-*.xml
